## Чат с комнатами и пользователями

Немного усложним задание, которое мы делали в предыдущем уроке.
На этот раз мы будем использовать стандартный gen\_server.

У нас будет поток **chat\_room\_manager**, который хранит в своем
состоянии комнаты.  Каждая комната -- отдельный поток **chat\_room**,
который хранит в своем состоянии пользователей и историю сообщений.
И каждый пользователь -- отдельный поток **chat\_user**, который хранит
в своем состоянии полученные сообщения.

Итого -- 3 модуля. Все они должны быть gen\_server.
chat\_room\_manager запускается в единственном
экземпляре, так что его поток можно зарегистрировать под именем
модуля. chat\_room и chat\_user запускаются в нескольких экземплярах,
так что их регистрировать не нужно, а нужно обращаться к ним по pid
потока.

Рассмотрим АПИ каждого модуля.


### chat_user.erl

**start_link/0** запускает новый поток пользователя.

**add_message/3** пользователь получает новое сообщение и сохраняет
его в своем состоянии.  На входе функция получает pid пользователя,
имя автора сообщения (binary) и текст сообщения (binary).
Функция всегда возвращает атом _ok_.

**get_messages/1** пользователь отдает список полученных сообщений,
сортированный от более старых сообщений к более новым.
На входе функция получает pid пользователя, на выходе отдает список сообщений,
где каждое сообщение представлено кортежем _{Name, Text}_.


### chat_room.erl

**start_link/0** запускает новый поток комнаты.

**add_user/3** добавляет нового пользователя в комнату.
Принимает pid комнаты, имя пользователя (binary) и pid пользователя.
Всегда возвращает атом _ok_.

**remove_user/2** удаляет пользователя из комнаты.
Принимает pid комнаты и pid пользователя. Возвращает _ok_, если пользователь
успешно удален, или _{error, user\_not\_found}_, если такого пользователя
в комнате не было.

**get_users/1** отдает список пользователей в комнате.
Принимает pid комнаты, возвращает список пользователей, где каждый
пользователь представлен кортежем вида _{Name, Pid}_.

**add_message/3** комната получает новое сообщение и рассылает его всем
пользователям. Принимает pid комнаты, имя автора сообщения (binary)
и текст сообщения (binary). Всегда возвращает атом _ok_.

**get_history/1** отдает список всех сообщений, пришедших в комнату,
сортированный от более старых сообщений к более новым.
Принимает pid комнаты, возвращает список сообщений,
где каждое сообщение представлено кортежем _{Name, Text}_.


### chat_room_manager.erl

**start_link/0** запускает chat\_room\_manager.

**create_room/1** создает новую комнату.
Принимает имя комнаты (binary) и возвращает комнату в виде кортежа _{Name, Pid}_.

**get_rooms/0** возвращает список комнат, где каждая комната представлена
кортежем _{Name, Pid}_. Комнаты в списке могут идти в произвольном порядке.

**add_user/3** добавляет нового пользователя в комнату.
Принимает pid комнаты, имя пользователя (binary) и pid пользователя.
Возвращает атом _ok_, если выполнилась успешно.
Или возвращает кортеж _{error, room\_not\_found}_, если заданая комната не найдена.

**remove_user/2** удаляет пользователя из комнаты.
Принимает pid комнаты и pid пользователя. Возвращает _ok_, если пользователь
успешно удален, или _{error, user\_not\_found}_, если такого пользователя
в комнате не было, или _{error, room\_not\_found}_, если заданая комната не найдена.

**get_users/1** отдает список пользователей в комнате.
Принимает pid комнаты. В успешном случае возвращает кортеж _{ok, Users}_,
Где Users -- список пользователей, представленых кортежем вида _{Name, Pid}_.
Или возвращает кортеж _{error, room\_not\_found}_, если заданая комната не найдена.

**send_message/3** посылает новое сообщение в комнату.
Принимает pid комнаты, имя автора сообщения (binary)
и текст сообщения (binary). В случае успеха возвращает атом _ok_.
Или возвращает кортеж _{error, room\_not\_found}_, если заданая комната не найдена.

**get_history/1** отдает список всех сообщений, пришедших в комнату,
сортированный от более старых сообщений к более новым.
Принимает pid комнаты. В случае успеха возвращает кортеж _{ok, Messages}_,
где Messages -- список сообщений, представленых кортежем _{Name, Text}_.
Или возвращает кортеж _{error, room\_not\_found}_, если заданая комната не найдена.

Не возбраняется реализовать и функцию **close_room/1** и добавить для нее тест :)
